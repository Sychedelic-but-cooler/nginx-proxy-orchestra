/**
 * Config Templates Utility
 *
 * Generates nginx configuration templates for new proxies
 * Templates include all required features (gzip, ACME challenge, security)
 * with placeholder values and helpful comments
 */

const ACME_WEBROOT = '/var/www/certbot';

/**
 * Generate a reverse proxy template
 */
function generateReverseProxyTemplate(name, options = {}) {
  const proxyName = name || 'New Proxy';

  let config = `# ═══════════════════════════════════════════════════════════════════\n`;
  config += `# Proxy: ${proxyName}\n`;
  config += `# Generated by Nginx Proxy Orchestra\n`;
  config += `# Edit the values below to match your requirements\n`;
  config += `# ═══════════════════════════════════════════════════════════════════\n\n`;

  // Force HTTPS redirect if SSL enabled
  if (options.ssl_enabled) {
    config += `# ───────────────────────────────────────────────────────────────────\n`;
    config += `# HTTP to HTTPS Redirect\n`;
    config += `# Automatically redirects all HTTP traffic to HTTPS\n`;
    config += `# ───────────────────────────────────────────────────────────────────\n`;
    config += `server {\n`;
    config += `    listen 80;\n`;
    config += `    listen [::]:80;\n`;
    config += `    server_name example.com www.example.com;  # Change to your domain(s)\n`;
    config += `\n`;
    config += `    # ACME challenge for Let's Encrypt certificate validation\n`;
    config += `    location /.well-known/acme-challenge/ {\n`;
    config += `        root ${ACME_WEBROOT};\n`;
    config += `        allow all;\n`;
    config += `    }\n`;
    config += `\n`;
    config += `    # Redirect all other HTTP traffic to HTTPS\n`;
    config += `    location / {\n`;
    config += `        return 301 https://$server_name$request_uri;\n`;
    config += `    }\n`;
    config += `}\n\n`;
  }

  // Main server block
  config += `# ───────────────────────────────────────────────────────────────────\n`;
  config += `# Main Server Block\n`;
  config += `# ───────────────────────────────────────────────────────────────────\n`;
  config += `server {\n`;

  // Listen directives
  if (options.ssl_enabled) {
    config += `    # Listen on HTTPS (port 443) with SSL/TLS encryption\n`;
    config += `    listen 443 ssl;\n`;
    config += `    listen [::]:443 ssl;\n`;
  } else {
    config += `    # Listen on HTTP (port 80) without encryption\n`;
    config += `    listen 80;\n`;
    config += `    listen [::]:80;\n`;
  }

  config += `\n`;
  config += `    # Domain names this proxy responds to\n`;
  config += `    server_name example.com www.example.com;  # Change to your domain(s)\n`;
  config += `\n`;

  // SSL configuration
  if (options.ssl_enabled) {
    config += `    # ───────────────────────────────────────────────────────────────\n`;
    config += `    # SSL/TLS Configuration\n`;
    config += `    # Certificate paths will be filled in automatically after selection\n`;
    config += `    # ───────────────────────────────────────────────────────────────\n`;
    config += `    ssl_certificate {{SSL_CERT_PATH}};\n`;
    config += `    ssl_certificate_key {{SSL_KEY_PATH}};\n`;
    config += `    ssl_protocols TLSv1.2 TLSv1.3;\n`;
    config += `    ssl_ciphers HIGH:!aNULL:!MD5;\n`;
    config += `    ssl_prefer_server_ciphers on;\n`;
    config += `\n`;
  }

  // ModSecurity placeholder
  if (options.waf_enabled) {
    config += `    # ───────────────────────────────────────────────────────────────\n`;
    config += `    # Web Application Firewall (ModSecurity)\n`;
    config += `    # Configuration will be set based on selected WAF profile\n`;
    config += `    # ───────────────────────────────────────────────────────────────\n`;
    config += `    modsecurity on;\n`;
    config += `    modsecurity_rules_file /etc/nginx/modsec/main.conf;\n`;
    config += `\n`;
  }

  // ACME challenge location
  config += `    # ───────────────────────────────────────────────────────────────\n`;
  config += `    # Let's Encrypt Certificate Validation\n`;
  config += `    # Required for automatic SSL certificate issuance and renewal\n`;
  config += `    # ───────────────────────────────────────────────────────────────\n`;
  config += `    location /.well-known/acme-challenge/ {\n`;
  config += `        root ${ACME_WEBROOT};\n`;
  config += `        allow all;\n`;
  config += `    }\n`;
  config += `\n`;

  // Main location block
  config += `    # ───────────────────────────────────────────────────────────────\n`;
  config += `    # Proxy Configuration\n`;
  config += `    # Routes all requests to the backend application\n`;
  config += `    # ───────────────────────────────────────────────────────────────\n`;
  config += `    location / {\n`;
  config += `        # Backend server URL\n`;
  config += `        proxy_pass http://localhost:8080;  # Change to your backend host:port\n`;
  config += `\n`;
  config += `        # Standard proxy headers\n`;
  config += `        proxy_set_header Host $host;\n`;
  config += `        proxy_set_header X-Proxy-Target $server_name;\n`;
  config += `        proxy_set_header X-Real-IP $remote_addr;\n`;
  config += `        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n`;
  config += `        proxy_set_header X-Forwarded-Proto $scheme;\n`;
  config += `\n`;

  // Information disclosure protection
  config += `        # Remove information disclosure headers from backend response\n`;
  config += `        # Prevents exposing server technology and version information\n`;
  config += `        proxy_hide_header X-Powered-By;\n`;
  config += `        proxy_hide_header Server;\n`;
  config += `        proxy_hide_header X-AspNet-Version;\n`;
  config += `        proxy_hide_header X-AspNetMvc-Version;\n`;
  config += `        proxy_hide_header X-Generator;\n`;
  config += `        proxy_hide_header X-Runtime;\n`;
  config += `        proxy_hide_header X-Drupal-Cache;\n`;
  config += `        proxy_hide_header X-Drupal-Dynamic-Cache;\n`;
  config += `        proxy_hide_header X-Varnish;\n`;
  config += `        proxy_hide_header Via;\n`;
  config += `        proxy_hide_header X-Application-Context;\n`;
  config += `        proxy_hide_header X-Mod-Pagespeed;\n`;
  config += `        proxy_hide_header X-Page-Speed;\n`;
  config += `\n`;

  // Gzip compression (always enabled)
  config += `        # Gzip compression to reduce bandwidth usage\n`;
  config += `        gzip on;\n`;
  config += `        gzip_vary on;\n`;
  config += `        gzip_proxied any;\n`;
  config += `        gzip_comp_level 6;\n`;
  config += `        gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;\n`;
  config += `\n`;

  config += `        # ───────────────────────────────────────────────────────────\n`;
  config += `        # Custom Directives\n`;
  config += `        # Add any additional nginx directives below\n`;
  config += `        # ───────────────────────────────────────────────────────────\n`;
  config += `\n`;
  config += `    }\n`;
  config += `}\n`;

  return config;
}

/**
 * Generate a stream (TCP/UDP) proxy template
 */
function generateStreamProxyTemplate(name, options = {}) {
  const proxyName = name || 'New Stream';
  const safeName = proxyName.replace(/[^a-zA-Z0-9]/g, '_');
  const protocol = options.protocol || 'tcp';

  let config = `# ═══════════════════════════════════════════════════════════════════\n`;
  config += `# Stream Proxy: ${proxyName} (${protocol.toUpperCase()})\n`;
  config += `# Generated by Nginx Proxy Orchestra\n`;
  config += `# TCP/UDP port forwarding configuration\n`;
  config += `# ═══════════════════════════════════════════════════════════════════\n\n`;

  config += `# ───────────────────────────────────────────────────────────────────\n`;
  config += `# Upstream Backend\n`;
  config += `# Defines the backend server(s) to forward traffic to\n`;
  config += `# ───────────────────────────────────────────────────────────────────\n`;
  config += `upstream stream_${safeName} {\n`;
  config += `    server localhost:3306;  # Change to your backend host:port\n`;
  config += `}\n\n`;

  config += `# ───────────────────────────────────────────────────────────────────\n`;
  config += `# Stream Server Block\n`;
  config += `# Listens on specified port and forwards traffic to upstream\n`;
  config += `# ───────────────────────────────────────────────────────────────────\n`;
  config += `server {\n`;
  config += `    # Listen on port (change to your desired port)\n`;
  config += `    listen 3306${protocol === 'udp' ? ' udp' : ''};  # Change to your listening port\n`;

  if (protocol === 'tcp') {
    config += `    listen [::]:3306;  # IPv6 support\n`;
  }

  config += `\n`;
  config += `    # Forward traffic to upstream\n`;
  config += `    proxy_pass stream_${safeName};\n`;
  config += `\n`;
  config += `    # ───────────────────────────────────────────────────────────────\n`;
  config += `    # Optional TCP-Specific Directives\n`;
  config += `    # Uncomment and customize as needed\n`;
  config += `    # ───────────────────────────────────────────────────────────────\n`;
  config += `    # proxy_connect_timeout 1s;      # Connection timeout\n`;
  config += `    # proxy_timeout 3m;              # Idle connection timeout\n`;
  config += `    # proxy_buffer_size 16k;         # Buffer size for proxying\n`;
  config += `}\n`;

  return config;
}

/**
 * Generate a 404 host template
 */
function generate404Template(name, options = {}) {
  const proxyName = name || 'New 404 Host';

  let config = `# ═══════════════════════════════════════════════════════════════════\n`;
  config += `# 404 Host: ${proxyName}\n`;
  config += `# Generated by Nginx Proxy Orchestra\n`;
  config += `# Returns 404 Not Found for all requests to specified domains\n`;
  config += `# ═══════════════════════════════════════════════════════════════════\n\n`;

  config += `# ───────────────────────────────────────────────────────────────────\n`;
  config += `# Server Block\n`;
  config += `# ───────────────────────────────────────────────────────────────────\n`;
  config += `server {\n`;
  config += `    # Listen on HTTP\n`;
  config += `    listen 80;\n`;
  config += `    listen [::]:80;\n`;

  if (options.ssl_enabled) {
    config += `\n`;
    config += `    # Listen on HTTPS\n`;
    config += `    listen 443 ssl;\n`;
    config += `    listen [::]:443 ssl;\n`;
    config += `\n`;
    config += `    # ───────────────────────────────────────────────────────────────\n`;
    config += `    # SSL/TLS Configuration\n`;
    config += `    # Certificate paths will be filled in automatically after selection\n`;
    config += `    # ───────────────────────────────────────────────────────────────\n`;
    config += `    ssl_certificate {{SSL_CERT_PATH}};\n`;
    config += `    ssl_certificate_key {{SSL_KEY_PATH}};\n`;
    config += `    ssl_protocols TLSv1.2 TLSv1.3;\n`;
  }

  config += `\n`;
  config += `    # Domain names to return 404 for\n`;
  config += `    server_name example.com www.example.com;  # Change to your domain(s)\n`;
  config += `\n`;

  // ACME challenge location
  config += `    # ───────────────────────────────────────────────────────────────\n`;
  config += `    # Let's Encrypt Certificate Validation\n`;
  config += `    # Required for automatic SSL certificate issuance and renewal\n`;
  config += `    # ───────────────────────────────────────────────────────────────\n`;
  config += `    location /.well-known/acme-challenge/ {\n`;
  config += `        root ${ACME_WEBROOT};\n`;
  config += `        allow all;\n`;
  config += `    }\n`;
  config += `\n`;

  config += `    # Return 404 for all other requests\n`;
  config += `    location / {\n`;
  config += `        return 404;\n`;
  config += `    }\n`;
  config += `}\n`;

  return config;
}

/**
 * Get template for proxy type
 */
function getTemplateForType(type, name, options = {}) {
  switch (type) {
    case 'reverse':
      return generateReverseProxyTemplate(name, options);
    case 'stream':
      return generateStreamProxyTemplate(name, options);
    case '404':
      return generate404Template(name, options);
    default:
      throw new Error(`Unknown proxy type: ${type}`);
  }
}

module.exports = {
  generateReverseProxyTemplate,
  generateStreamProxyTemplate,
  generate404Template,
  getTemplateForType
};
